<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Kanałów TV - Magnus544x</title>
    <!-- Ładowanie Tailwind CSS (dla nowoczesnego stylowania) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ładowanie HLS.js (kluczowe do odtwarzania strumieni .m3u8 we wszystkich przeglądarkach) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* Konfiguracja czcionki */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Ciemne tło */
            color: #c9d1d9; /* Jasny tekst */
        }
        /* Styl dla linków kanałów */
        .channel-link {
            transition: all 0.2s ease-in-out;
        }
        .channel-link:hover {
            background-color: #30363d;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.15);
        }
        /* Styl dla aktywnego/wybranego kanału */
        .channel-link.active {
            background-color: #1f6feb;
            color: white;
            font-weight: 600;
        }
        /* Kontener wideo - stała wysokość w widoku desktop, responsywna na mobilu */
        #videoContainer {
            min-height: 400px;
        }
        /* Przewijana lista kanałów - dostosowuje się do wysokości ekranu na desktopie */
        #channelList {
            max-height: calc(100vh - 200px); 
            overflow-y: auto;
        }
        /* Ukrycie domyślnego odtwarzacza przed załadowaniem */
        #tvPlayer {
            display: none;
        }
        /* Styl dla komunikatu "Wybierz Kanał" */
        #selectChannelMessage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.8);
            font-size: 1.5rem;
            text-align: center;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Nagłówek i Nawigacja -->
        <header class="mb-6 pb-4 border-b border-gray-700 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white">Magnus TV</h1>
            <a href="index.html" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition duration-150">
                &larr; Wróć do Strony Głównej
            </a>
        </header>

        <!-- Główny Kontener: Wideo (lewo) i Lista Kanałów (prawo) -->
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- Sekcja Odtwarzacza Wideo -->
            <div class="lg:w-3/4">
                <div id="videoContainer" class="bg-black aspect-video rounded-xl shadow-2xl overflow-hidden mb-4 relative">
                    <video id="tvPlayer" controls class="w-full h-full object-contain"></video>
                    <!-- Komunikat do czasu wybrania kanału -->
                    <div id="selectChannelMessage" class="text-white p-4">
                        Wybierz kanał z listy po prawej, aby rozpocząć odtwarzanie.
                    </div>
                    <!-- Wyświetlanie nazwy aktualnego kanału -->
                    <div id="currentChannelName" class="absolute top-0 left-0 m-4 p-2 bg-black bg-opacity-75 text-white text-lg font-semibold rounded-lg hidden">
                        Wybierz kanał
                    </div>
                </div>

                <!-- Komunikat ładowania/błędu -->
                <div id="statusMessage" class="text-center text-yellow-400 font-semibold mt-4">Ładowanie listy kanałów...</div>
            </div>

            <!-- Sekcja Listy Kanałów (Prawa, Przewijana) -->
            <div class="lg:w-1/4 bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-3 text-white">Dostępne Kanały</h2>
                <div id="channelList" class="space-y-2">
                    <!-- Lista kanałów zostanie wypełniona przez JavaScript -->
                    <p class="text-gray-400 text-sm">Czekam na dane...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Adres URL do pliku M3U
        const M3U_URL = 'https://raw.githubusercontent.com/magnus544x/magnus544x/main/playlist.m3u';
        const player = document.getElementById('tvPlayer');
        const channelListDiv = document.getElementById('channelList');
        const statusMessage = document.getElementById('statusMessage');
        const currentChannelNameDiv = document.getElementById('currentChannelName');
        const selectChannelMessage = document.getElementById('selectChannelMessage');
        let currentActiveChannel = null;
        let hlsInstance = null; // Instancja HLS.js

        // --- Inicjalizacja HLS.js ---
        if (Hls.isSupported()) {
            hlsInstance = new Hls();
            hlsInstance.attachMedia(player);

            // Dodajemy zaawansowaną obsługę błędów dla HLS.js
            hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    let errorMessage = `Błąd fatalny HLS (${data.type}): ${data.details}.`;
                    
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            errorMessage += " Błąd sieci: Strumień jest nieosiągalny lub URL jest nieprawidłowy.";
                            hlsInstance.startLoad(); // Spróbuj wznowić ładowanie
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            errorMessage += " Błąd mediów. Próbuję odzyskać błąd...";
                            hlsInstance.recoverMediaError();
                            break;
                        default:
                            errorMessage += " Próbuję zniszczyć i ponownie utworzyć HLS.js.";
                            if (hlsInstance) {
                                hlsInstance.destroy();
                                hlsInstance = new Hls();
                                hlsInstance.attachMedia(player);
                            }
                            break;
                    }
                    console.error("HLS Fatal Error:", errorMessage, data);
                    statusMessage.textContent = errorMessage;
                    statusMessage.classList.remove('text-green-400', 'text-yellow-400');
                    statusMessage.classList.add('text-red-400');
                }
            });

        } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
            // Natywna obsługa HLS (np. Safari)
            statusMessage.textContent = 'Korzystam z natywnej obsługi HLS Twojej przeglądarki.';
        } else {
            statusMessage.textContent = 'Uwaga: Twoja przeglądarka nie obsługuje strumieni HLS. Niektóre kanały mogą nie działać.';
            statusMessage.classList.add('text-red-400');
        }

        // --- Funkcje pomocnicze dla parsowania M3U ---

        function parseM3U(data) {
            const lines = data.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const channels = [];
            let currentChannel = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.startsWith('#EXTINF:')) {
                    currentChannel = {};
                    const nameMatch = line.match(/,(.*)$/);
                    if (nameMatch && nameMatch[1]) {
                        currentChannel.name = nameMatch[1].trim();
                    } else {
                        currentChannel.name = 'Nieznany Kanał';
                    }
                    const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                    if (logoMatch && logoMatch[1]) {
                        currentChannel.logo = logoMatch[1];
                    }

                } else if (!line.startsWith('#') && lines.length > i) {
                    currentChannel.url = line;
                    if (currentChannel.name && currentChannel.url) {
                        channels.push(currentChannel);
                    }
                }
            }
            return channels;
        }

        // --- Funkcje interakcji ---

        function playChannel(channel, listItem) {
            // 1. Ustawienia wizualne
            selectChannelMessage.classList.add('hidden');
            player.style.display = 'block';
            currentChannelNameDiv.classList.remove('hidden');

            const url = channel.url;
            statusMessage.textContent = `Ładowanie: ${channel.name}...`;
            statusMessage.classList.remove('text-green-400', 'text-red-400');
            statusMessage.classList.add('text-yellow-400');
            currentChannelNameDiv.textContent = channel.name;

            // 2. Wyczyszczenie poprzedniego stanu odtwarzacza
            player.pause(); // Zawsze zatrzymujemy odtwarzanie
            if (hlsInstance) {
                hlsInstance.stopLoad(); // Zatrzymujemy ładowanie HLS
            }
            player.removeAttribute('src'); // Usuwamy stare źródło, aby uniknąć konfliktów
            player.load();

            // 3. Ładowanie nowego strumienia
            if (url.endsWith('.m3u8') && hlsInstance) {
                // Użycie HLS.js
                hlsInstance.loadSource(url);
                hlsInstance.attachMedia(player); // Ponowne podłączenie dla pewności
            } else if (player.canPlayType('application/vnd.apple.mpegurl') && url.endsWith('.m3u8')) {
                 // Natywna obsługa HLS (tylko Safari/iOS)
                player.src = url;
            } else {
                // Standardowe odtwarzanie
                player.src = url;
            }

            // 4. Uruchomienie odtwarzania
            player.play()
                .then(() => {
                    statusMessage.textContent = `Odtwarzanie: ${channel.name}`;
                    statusMessage.classList.remove('text-yellow-400');
                    statusMessage.classList.add('text-green-400');
                })
                .catch(e => {
                    // Blokada autoplay lub inny błąd odtwarzania
                    console.error("Błąd odtwarzania:", e);
                    statusMessage.textContent = `Uwaga: Wybierz ponownie kanał "${channel.name}" i kliknij PLAY na odtwarzaczu. Przeglądarka mogła zablokować automatyczne odtwarzanie lub strumień jest niedostępny.`;
                    statusMessage.classList.remove('text-yellow-400', 'text-green-400');
                    statusMessage.classList.add('text-red-400');
                });


            // 5. Aktualizacja aktywnego stanu na liście
            if (currentActiveChannel) {
                currentActiveChannel.classList.remove('active', 'bg-blue-600');
                currentActiveChannel.classList.add('bg-gray-700');
            }
            listItem.classList.add('active', 'bg-blue-600');
            listItem.classList.remove('bg-gray-700');
            currentActiveChannel = listItem;
        }

        // Funkcja do renderowania listy kanałów w DOM
        function renderChannelList(channels) {
            channelListDiv.innerHTML = '';
            if (channels.length === 0) {
                channelListDiv.innerHTML = '<p class="text-red-400">Nie znaleziono żadnych kanałów w pliku M3U.</p>';
                return;
            }

            channels.forEach(channel => {
                const listItem = document.createElement('a');
                listItem.href = '#';
                listItem.className = 'channel-link w-full flex items-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer';

                // Dodanie logo lub inicjału
                const logoContainer = document.createElement('div');
                logoContainer.className = 'w-6 h-6 flex items-center justify-center bg-blue-700 text-white rounded-md mr-3 text-xs font-bold flex-shrink-0';
                
                if (channel.logo) {
                    const logo = document.createElement('img');
                    logo.src = channel.logo;
                    logo.alt = `${channel.name} Logo`;
                    logo.className = 'w-full h-full object-contain rounded-md';
                    logo.onerror = function() {
                        // Fallback do inicjału, gdy logo nie działa
                        logoContainer.innerHTML = channel.name.charAt(0);
                    };
                    logoContainer.appendChild(logo);
                } else {
                    logoContainer.textContent = channel.name.charAt(0);
                }
                listItem.appendChild(logoContainer);


                const nameSpan = document.createElement('span');
                nameSpan.textContent = channel.name;
                nameSpan.className = 'truncate';
                listItem.appendChild(nameSpan);

                // Obsługa kliknięcia
                listItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    playChannel(channel, listItem);
                });

                channelListDiv.appendChild(listItem);
            });


            statusMessage.textContent = `Pomyślnie załadowano ${channels.length} kanałów. Wybierz kanał, aby rozpocząć odtwarzanie.`;
            statusMessage.classList.remove('text-yellow-400');
            statusMessage.classList.add('text-green-400');
        }

        // --- Główna funkcja ładowania ---

        async function loadChannels() {
            try {
                // Pobranie pliku M3U
                const response = await fetch(M3U_URL);

                if (!response.ok) {
                    throw new Error(`Błąd HTTP: ${response.status}`);
                }

                const m3uText = await response.text();
                const channels = parseM3U(m3uText);
                renderChannelList(channels);

            } catch (error) {
                console.error("Wystąpił błąd podczas ładowania kanałów:", error);
                statusMessage.textContent = `Błąd: Nie udało się załadować listy kanałów z M3U. Sprawdź URL. (${error.message})`;
                statusMessage.classList.remove('text-yellow-400', 'text-green-400');
                statusMessage.classList.add('text-red-400');
                channelListDiv.innerHTML = `<p class="text-red-400 p-2">Nie udało się załadować kanałów.</p>`;
            }
        }

        // Uruchomienie ładowania po załadowaniu skryptu
        window.onload = loadChannels;
    </script>
</body>
</html>
